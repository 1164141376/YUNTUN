# Redis 主从复制

### 概念

主从复制：是指将一台Redis服务器的数据，复制到其他的Redis服务器。前者称为主节点，后者称为丛及诶单；数据的复制是单项的，只能由主节点到从节点。

默认情况下，每台Redis服务器都是主节点；且一个主节点可以有多个从节点，单一个从节点只能有一个主节点

#### 主从复制的主要作用包括：

1、数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式。

2、故障恢复：当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复；实际上是一种服务的冗余。

3、负债均衡：在主从复制的基础上，配合读写分离，可以由主节点提供服务，由从节点提供读服务，分带服务器负载；尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大大提高Redis服务器的并发量。

4、高可用（集群）基石：除了上述作用以外，主从复制还是哨兵和集群能够实施的基础，因此说主从复制是Redis高可用的基础





## 环境配置

只配置从库，不用配置主库！

```bash
info replication # 查看当前库的信息
```

复制3个配置文件，然后修改对应信息

1、端口

2、pid 名字

3、log文件名字

4、dump.rdb 名字

启动后通过进程查看信息



### 一主二从

一般情况下只配置从机

```bash
SLAVEOF IP+Port # 认老大
```

真实情况的主从配置是在配置文件中：

> 细节

主机可以写，从机**只能读**！主机中的所有信息和数据，都会自动被从机保存

如果使用命令行，配置的主从，重启了就变成主机！只要变成从机，立马就会获取值！

> 复制原理

Slave 启动成功连接到 master 后悔发送一个 sync 同步命令

Master 接到命令，启动后台的存盘进程，同时收集所有接收到的用于修改数据集命令，在后台进程执行完毕，master将传送整个数据文件到slave，并完成一次同步。

全量复制：而slave服务在接收到数据库文件数据后，将其存盘并加载到内存中。

增量复制：Master继续将新的所有收集到的修改命令一次传给slave，完成同步

但是只要是重新连接master，一次完全同步（全量复制）将被自动执行

> slaveof no one 自己变主机





## 哨兵模式

> 概述

主从切换技术的方法是：当主服务器宕机后，需要手动吧一台服务器切换为主服务器，这就需要人工干预，费时费力，还会造成一段时间服务不可用，这不是一种推荐的方式，更多时候有限考虑哨兵模式。Redis从2.8开始正式提供了Sentinel（哨兵）架构来解决这个问题。

能够后台监控主机是否故障，如果故障了根据投票数**自动将从库转换为主库**。

哨兵模式是一种特殊的模式，首先Redis提供了哨兵的命令，哨兵是应该独立的进程，作为进程，它会独立运行。其原理是哨兵通过发送命令，等待Redis服务器响应，从而监控多个Redis实例。



哨兵模式有两个作用

- 通过发送命令，让redis服务器返回并监控其运行状态，包括主、从服务器。
- 当哨兵检测到master宕机，会自动将slave切换成master，然后通过**发布订阅模式**通知其他从服务器，修改配置文件，让他们切换主机



![image-20201119174841972](11.Redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6.assets/image-20201119174841972.png)

假设主服务器宕机，哨兵1先检测到这个结果，系统并不会马上进行failover过程，仅仅是哨兵1主观认为服务器不可用，这个现象称为**主观下线**，后面的哨兵也检测到主服务器不可用，并且数量达到一定值时，那么哨兵之间就会进行一次投票，投票由一个哨兵发起，进行failover[ 故障转移 ] 操作。切换成功后，就会通过发布订阅模式，让各各哨兵把自己监控的从服务器实现切换主机，这个过程称为**客观下线**。

> 测试！

1、配置哨兵配置文件 sentinel.conf

```bash
# sentinel monitor 被监控的名词 host port 1
sentinel monitor myredis 127.0.0.1 6379 1
```

后面的这个数字1，代表主机挂了，slave投票看让谁接替成为主机！

2、启动哨兵！

如果Master节点断开，这个时候就会从从机中随机选一个服务器！（有一个投票算法）



如果此时主机回来了，只能归并到新的主机下当从机！

> 哨兵模式

优点： 

- 哨兵集群，基于主从复制模式，所有的主从配置有点，它全有
- 主从可以切换，故障可以转移，系统的可用性就会更好
- 哨兵模式就是主从模式的升级，手动到自动，更加健壮！

缺点：

- Redis不好在线扩容，集群容量一旦达到上限，在线扩容就十分麻烦
- 实现哨兵模式的配置其实是很麻烦的，有很多选择





























