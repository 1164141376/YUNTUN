# 1 计算机网络和因特网

### 1.1.1具体构成

主机 或 端系统

​		指电脑，手机，电视等

端系统通过**通信链路层**和**分组交换机**连接到一起

​		包括：同轴电缆，铜线，光纤和无线电

​		不同的链路能够以不同的速率传输数据，**传输速率**以比特/秒度量（bit/s或bps）

​		当一台要向另外一台发送数据，发送端的系统会将数据分段，为每段加上首部字节。简单来说就是**分组**，这些分组通过网络发送到目的地的系统，在哪里被装配成初始数据

​		**路由器**和**链路层交换机**属于分组交换机，它们的目的是转发分组

​		一个分组所经历的一系列通信链路和分组交换机称为通过网络的**路劲**

​		IETF的的标准文档称为**请求评论**（RFC）

​				它定义了TCP、IP、HTTP和SMTP（用于电子邮件）等协议

### 1.1.2服务描述

​		像在线社交网络、视频会议、多人游戏，这些应用程序涉及多个相互交换数据的端系统，称为**分布式应用程序**

​		端系统提供了一个**套接字接口**，该接口规定了向另一个端系统交付数据的方式。因特网套接字接口是一套发送程序必须遵循的**规则集合**。

### 1.2.2物理媒体

​		“发射器—接收器” 为一对，端媒体到端媒体中间可能有很多对。称为**物理媒体**，有双绞铜线，同轴电缆，多模光纤缆等。

​		物理媒体可以分为两种类型：**导引型媒体**，和**非导引型媒体**，导引型可以前进，比如光缆，同轴电缆，非导引型就是在空气或外层空间传播，无线类的



## 1.3网络核心

### 1.3.1分组交换

​		端系统彼此交换**报文**，报文可以执行一种控制功能，为了从源端向目的的端系统发送一个报文，源将长报文划分为较小的数据块，称为**分组**，每个分组都通过通信链路和**分组交换机**传送，分组交换机有两类：**路由器**和**链路层交换机**，

​		1.存储转发传输

​			多数分组交换机在链路的输入端使用**存储转发传输**机制。这一机制是指在交换机开始**输出**该分组的第一个比特之前，必须接收到整个分组。

​		2.排队时延和分组丢失

​			对于每一个链路，分组交换机都有一个**输出缓存**，也叫输出队列，除了存储转发的时延，分组还要承受**排队的时延**，这些时延取决于网络拥塞的程度。如果分组占满了可能还会出现**分组丢失（丢包）**。

​		3.转发表和路由选择协议

​			源在该分组的首部包含了目的地的IP地址，当分组到达路由器的时候，检查该地址的一部分，并向相邻的路由器转发该分组，每台路由器还有一个**转发表**，将目的地址映射为输出链路，**路由选择协议**，用于自动地设置这些转发表，可以决定从每台路由器到每个目的地的最短路径，并使用这些最短路径结果来配置路由器中的转发表。



### 1.3.2电路交换

​		**电路交换和分组交换**，电路交换预留了所需的资源（缓存，链路传输速率），在分组交换的时候这些资源不预留，回话的报文按需使用这些资源，它的后果是可能不得不等待接入通信线路。

​		传统的电话网络就是电弧交换网络的例子，在发送方发送信息之前，建立了与接收方的链接，名副其实的是一条连通的**电路**。预定了传输速率





## 1.4分组交换网中的时延、丢包和吞吐量

### 1.4.1分组交换网中的时延概述

​		一个分组从一个节点（主机或路由器）沿着这条路径到后继节点（主机或路由器），该分组经受了几种不同类型的时延，最为重要的是**节点处理时延、排队时延、传输时延、和传播时延**，这些时延加起来就是**节点总时延**

​		La bps是比特到达队列的平均速率，R是传输速率，La/R被称为**流量强度**，如果La/R > 1，说明比特到达队列的平均速率超过该队列传输出去的速率，那么该队列的队列趋向于无限增加！！！因此流量工程中的一条金科玉律是：设计系统时流量强度不能大于1。

#### 丢包

​		分组到达路由器发现队列满的，路由器将**丢弃**该分组，即该分组将会**丢失**。分组丢失的比例，随着流量强度的增加而增加。



## 1.5协议层次及其服务模型

### 1.5.1分层的体系结构

1.协议分层

​		为了给网络协议的设计提供一个结构，网络设计者以**分层**的方式组织协议以及实现这些协议的网络硬件和软件。

​		我们再次关注某层**向它的上一层提供**的**服务**，即所谓的一层的**服务模型**。

​		各层的所有协议被称为**协议栈**，因特网的协议栈由5个层次组成：物理层、链路层、网络层、运输层和应用层。

（1）应用层

​		是网络应用程序及它们的应用协议存留的地方，因特网的应用层有HTTP（提供了Web文档的请求和传送），SMTP（提供了电子邮件报文的传输）和FTP（提供了俩个端系统之间的文件传送）。将URL转换为32比特的网络地址是域名系统（DNS）完成的。应用层协议分布在很多端系统上，一个端系统中的应用程序使用协议与另外一个端系统中的应用程序交换信息分钟，我们把这种位于应用层的信息分组称为**报文**。

（2）运输层

​		因特网的传输层在应用程序的断电之间传送应用层报文，在因特网中有俩种传输协议，即TCP和UDP，利用其中任一个都能传输应用层报文。TCP向它的应用程序提供了面向连接的服务，这种服务包括了应用层的报文想目的地的确保传递和流量控制（即发送方/接收放速率匹配）。TCP也将长报文划分为短报文，并提供拥塞控制机制，因此当网络拥塞时，源抑制其传输速率。UDP提供无连接服务，没有可靠性，没有流量控制，没有拥塞控制。我们把运输层的分组称为**报文段**。

（3）网络层

​		因特网的网络层将称为**数据报**的网络层分组从一台主机移动到另一台主机。源主机运输层协议给网络层它的报文段和目的地址。网际协议IP

（4）链路层

​		为了将分组从一个节点移动到路径上的下一个节点（主机或路由器），网络层必须依靠该链路层的服务。网络层将数据报下穿给链路层，链路层沿着路径到达下一个节点，链路层将数据报上传给网络层。我们把链路层分组称为**帧**。

（5）物理层

​		物理层的任务是将该帧中的应该个个比特从一个节点移动到下一个节点。这层中的协议仍然是链路层相关，并且与该链路（如，双绞铜线，单模光纤）的实际传输媒体相关，例如，以太网具有许多物理层协议：一个是关于双绞铜线的，另外一个是同轴电缆，还有一个是关于光纤的。跨越这些；链路中移动一个比特的方式都是不同的。



### 1.5.2封装

​		封装。在发送的主机端，一个**应用层报文**被传送给运输层，运输层收取到并附加信息，该信息将被接收端的运输层使用。应用层报文和运输层报文信息构成了**运输层报文段**。所以运运输层的报文段封装了应用层的报文（差错检测等）。运输层想网络层传递该报文段，同样的一俩车增加了如源和目的端系统地址等网络层的首部信息，生成了**网络层数据报**，接着该数据报接下来传递给链路层，链路层增加它的首部信息并生成**链路层帧**。所以我们可以看到，在每一层，一个分组有两种类型的字段：首部字段和**有效载荷字段**，有效载荷通常上一层的分组





# 2 应用层

## 2.1应用层协议原理

### 2.1.1网络应用程序体系结构

​		**应用程序体系结构**是由应用程序研发者设计，规定了如何在各种端系统上组织该应用程序。在选着应用程序体系结构时，应用程序研发者很可能利用目前两种主流的结构：客户-服务器体系结构或对等（P2P）体系结构。

​		在**客户-服务器体系结构**中。有一个总是打开的主机称为服务器，它服务于来自许多其他称为客户的主机的请求。

​		在**P2P体系结构**中，对位于数据中心的专用服务器有最小的（或者没有）依赖。最引人入胜的特性质疑是他们的**自拓展性**。



### 2.1.2进程通信

1.客户和服务器进程

​		对于每对通信的进程，经常讲这两个进程之一标识为**客户**，而另外一个标识为**服务器**。在一对进程之间的通信会话场景中，发起通信的进程被标识为**客户**，在会话开始时等待联系的进程是**服务器**。



2.进程与计算机网络之间的接口

​		进程通过一个称为**套接字**（socket）的软件向网络发送报文和从网络接收报文。套接字是同一台主机内应用层与运输层之间的接口。由于套接字是经历网络应用程序的可编程接口，因此套接字也称为应用程序和网络之间的**应用程序编程接口**。应用程序开发者可以控制套接字在应用层端的一切，但是对运输层端几乎没有控制器，对运输层的控制权限仅限于：1.选择运输层协议；2.也许能设定几个运输层参数（如果可供选择的话），则应用程序就建立在由该协议提供的运输层服务之上。

3.进程寻址

​		一台主机上的进程向另外一台主机上的进程发送分组，需要有一个地址来标识该接收进程，需要定义两种信息：1.主机的地址；2.在目的的主机中指定接收进程的标识符

​		在因特网中，主机由其**IP地址**标识，IP地址是一个32比特的量，能够唯一标识该主机。还需要目的地**端口号**。



### 2.1.3可供应用程序使用的运输服务

​		一个运输层协议能够为电泳它的应用程序提供哪些服务，这些服务分为四个方面：可靠数据传输，吞吐量，定时和安全性。

​		1.可靠数据传输

​		为了支持一些需要可靠传输的应用，必须做一些工作以确保由应用程序的一端发送的数据正确、完全地交付给该应用程序的另一端。如果一个协议提供了这样的确保数据交付服务，就认为提供了**可靠数据传输**。

​		当一个运输层协议不提供可靠数据传输时，这可能表示发送的某些数据可能到达不了接收的进程，这可能被**容忍丢失的应用**手接收，例如多媒体应用，交谈式音频/视频。

​		2.吞吐量

​		运输层协议能够以某种特定的速率提供确保的可用吞吐量。使用这种服务，该应用程序能够请求r比特/秒的确保吞吐量，并且该运输协议能够确保吞吐量总是为至少r比特/秒，具有吞吐量要求的应用程序被称为**带宽敏感的应用**，许多当前的多媒体应用是带宽敏感的。而**弹性应用**能够根据当时可用的带宽或多或少地利用可供使用的吞吐量。例如，电子邮件，文件传输以及web传送。

​		3.定时

​		运输层也能提供定时保证，发送方注入套接字中的每个比特达到接收方的套接字不迟于100ms。

​		4.安全性

​		传输协议能够为应用程序提供一种或多种安全性服务。例如在发送主机中，运输协议能够加密由发送进程传输的所有数据，在接收主机中，传输层协议能够在数据交付给接收进程之前解密这些数据。这种服务在两者之前提供了机密性，运输协议还能提供数据完整性和端点鉴别。



2.1.4因特网提供的传输服务

​		1.TCP服务

​		面向连接的服务：在应用层数据报文开始流动之前，TCP让客户和服务器相互交换运输层控制信息。在握手阶段后，一个**TCP连接**在两个进程的套接字之间建立了。这条连接是全双工的

​		可靠的数据传送服务：通信进程能够依靠TCP，无差错、按适当顺序交付所有发送的数据。

​		TCP协议还具有拥塞控制机制，不一定为通信进程带来直接好处，但是能为因特网带来整体好处。

​		TCP安全

​		TCP、UDP都没有提供任何加密机制，在任何中间链路都有可能被嗅探和发现。所以因特网界已经研制了TCP的加强版本，称为**安全套接字层**（Secure Sockets Layer,**SSL**）。SSL在基于TCP的功能上还提供了进程到进程的安全性服务，包括加密，数据完整性和端点鉴别。这种强化是在应用层上实现的。

​		2.UDP服务

​		是一种不提供不必要服务的轻量级运输协议。

​		3.因特网运输协议所不提供的服务

​		对吞吐量和定时保证。

### 2.1.5应用层协议

​		**应用层协议**定义了运行在不同端系统上的应用程序进程如何相互传递报文。HTTP只是Web应用的一个部分。



### 2.2.1 HTTP概况

​		HTTP是一个**无状态协议**，如果向一个服务器发送相同的请求，服务器则都会响应，不因为客户发送同样的请求，不记录客户的状态。



### 2.2.2 非持续连接和持续连接

​		每一个请求都经过一个单独的TCP连接发送，就是**非持续连接**，所有请求都由一个TCP发送就是**持续连接**。

### 2.2.3 HTTP报文格式

1.HTTP请求报文

![HTTP请求报文](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200709132352566.png)

​		HTTP请求报文的第一行叫做**请求行**，其后继的行叫做**首部行**。

请求行有3个字段：方法字段、URL字段、和HTTP版本字段。

方法字段可以有：GET、POST、HEAD、PUT和DELETE

Connection：close 告诉浏览器不必麻烦地使用持续连接

User-agent：浏览器类型

Accept-language：用户想得到该对象的语法版本

![HTTP格式](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200709133255323.png)

使用GET方法时实体体为空，POST方法才使用该实体体



2.HTTP响应报文

![HTTP响应报文](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200709133823835.png)

响应报文有三个部分：一个初始**状态行**，6个**首部行**，然后是**实体体**。

状态行有3个字段：协议版本字段、状态码和相应状态信息

首部行：

Connection：close首部行告诉客户，发送完报文后将关闭该TCP连接。

Date：首部行指示服务器产生并发送该响应报文的日期和时间。这个时间是指服务器从它的文件系统中检索到该对象，将该对象插入响应报文，并发送该响应报文的时间。

Server：首部行指示该报文是由一台Apache Web服务器产生的

Last-Modified：对象创建或者最后修改的日期和时间。

Content-Length：指示实体体中的对象是HTML文本。

![HTTP报文格式](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200709145425630.png)



2.2.4	用户与服务器的交互：cookie

2.2.5 	Web缓存

​		在出去之前先访问Web缓存服务器，降低流量强度

2.2.6	条件GET方法

​		web高速缓存的东西很可能是旧的，但是HTTP有一种机制，允许缓存器证实它的对象是最新的。

这种机制就是**条件GET**方法。

​		1.使用GET方法	2.包含首部行If-Modified-Since：

​		缓存器向服务器检测是否更新



## 2.4	DNS：因特网的目录服务

2.4.1	DNS提供的服务

​		能进行主机名到IP地址的转换目录服务，这就是**域名系统**，DNS是：

1.由一个分层的**DNS服务器**实现的分布式数据库。

2.使得主机能够查询分布式数据库的应用层协议。

DNS协议运行在UDP之上，使用53端口。

2.4.2	DNS工作机理概述

1.分布式、层次数据库

**根DNS服务器**

**顶级域服务器**

**权威DNS服务器**

![DNS三种服务器](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200709160300348.png)

还有另一类重要的DNS服务器，称为**本地DNS服务器**

![DNS递归+迭代请求](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200709160917190.png)

请求主机到本地DNS服务器是递归查询，其他的都是迭代查询，实践中通常遵循这种查询方式。

2.DNS缓存



2.4.3	DNS记录和报文

实现DNS分布式数据库的所有DNS服务器存储了**资源记录（RR）**，RR提供了主机名到IP地址的映射，每个DNS回答报文包含了一条或多条RR，RR是一个包含了下列字段的4元组。

（Name，Value，Type，TTL）

​		TTL是该记录的生存时间，它决定了从缓存中删除的时间，Name和Value的值取决于Type。

1.DNS报文

​		DNS只有查询和回答报文，并且格式相同。

![DNS报文格式](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200709162651084.png)

# 3	运输层

3.1.2因特网运输层概述

​		IP、UDP被称为不可靠服务、TCP可靠数据传输

​		IP让两台主机之间进行交互，而UDP和TCP提升到了进程间的数据交互

## 3.2	多路复用与多路分解

将运输层的报文段交付到正确的套接字称为**多路分解**，在源主机中从不同套接字收集数据块，并封装成报文段，将报文段传递到网络称为多路复用。



## 3.3	无连接运输：UDP

### 3.3.1	UDP报文段结构

![UDP报文段结构](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200710145120067.png)

3.3.2	UDP检验和

​		如果端到端数据传输服务要提供差错检测，UDP就必须在端到端基础上的运输层提供差错检测，这是在系统设计中被称颂为**端到端原则**，与在较高级别提供这些功能的代价相比，在较低级别上设置的功能可能是冗余的或几乎没有价值的。

​		虽然UDP提供差错检测，但它对差错恢复无能为力。



## 3.4可靠数据传输原理

3.4.1构造可靠的数据传输协议

​		1.经过完全可靠信道的可靠数据传输：rdt 1.0

​		在这个协议中，有了完全可靠的信道，接收端就不需要提供任何反馈信息给发送方，不必担心出现差错，接收方接收数据的速率与发送方发送的速率一样快，因此接收方没必要要求发送方发送慢一点。



​		2.经过具有比特差错信道的可靠数据传输：rdt 2.0

​		**肯定确认（ACK），否定确认(NAK)**。这些控制报文使得接收方让发送方知道哪些东西被正确接收，哪些内容接收有误并因此需要重复。基于这样的重传机制的可靠传输协议称为**自动重传请求协议**（Automatic Repeat reQuest，ARQ）。

​		ARQ协议中还需要另外三种协议功能来处理存在比特差错的情况。

​		差错检测

​		接收方反馈

​		重传

​		发送方发送过后，变为等待状态，等待接收方的ACK或者NAK，如果是ACK继续发送下一个分组，如果是NAK重新发送分组。所以rdt 2.0称被称为**停等**协议。

​		怎么解决  	处理受损ACK和NAK的情况？

​		答：在数据分组中添加一个新字段，让发送方对其数据分组编号，发送分组的**序号**放在该字段。

rdt  2.1状态数是以前的两倍，希望接收的分组的序号是0还是1，让接收方知道发送方是否在重传前一个发送分组

rdt 2.2 冗余ACK，去掉NAK，如果是NAK的情况让接受方多发送上一个分组的ACK，如果接收同一个分组的两个ACK那么他后面的分组很可能没有正确接收





3.经过具有比特差的丢包信道的可靠数据传输：rdt 3.0 因为分组序号在0，1之间交替，所以有时被称为**比特交替协议**。

​		为了实现基于时间的重传机制，需要一个**倒计数定时器**。

1、每发送一个分组，启动一个定时器

2、响应定时器中断

3、终止定时器



​		在检验、序号、定时器、肯定和否定确认分组这些技术中，在协议运行起到了必不可少的作用。



### 3.4.2	流水线可靠数据传输协议

​		rdt 3.0是一个功能正确的协议，但是性能不行。

​		**流水线**，解决流水线的差错恢复有两种基本方法是：**回退N步和选择重传**

### 		流水线



​		发送方（或者信道）的**利用率**：发送方发送比特的时间，比上发送时间，示例U = 0.008/30.008 = 0.00027（低）

​		必须增加序号范围，因为每个传送中的分组（不计算重传）必须有有个唯一标识，而且有许多个在输送中的未确认报文。

​		协议的发送方和接收方两端可能不得不缓存多个分组。发送发最低限度应该缓存已经发送但是还没有确认的分组。接收方应该也要缓存已经正确接收的分组。

​		所需要序号范围和缓冲的要求取决于数据传输协议如何处理丢失、损坏及延时过大的分组。解决流水线的差错恢复有两种基本方法是：**回退N步和选择重传**。



### 3.4.3 回退N步

​		在**回退N步（GBN）**协议中，允许发送方发送多个分组（有可以发送的分组时）不需要等待确认，但是也受限于流水线的未确认的分组不能超过某个最大允许数N。

​		我们将基序号定义为早的未确认的分组序号，将下一个序号定义为准备马上要发送分组的序号，那么可以将序号范围分割成4个部分。

​		[ 0，base - 1 ]内的序号为已发送且确认的分组

​		[ base, nextseqnum - 1 ] 内的是已经发送但是未确认的分组

​		[ nextseqnum , base+N-1] 内是可以要被发送的分组

​		[ base + N, 之后的] 是不可用

![GBN滑动窗口协议](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200711191059510.png)

​		那些已经被发送但是还没有确认的分组和许可序号的范围可以看成是有个在序号范围内长度为N的窗口，随着协议运行，该窗口在序号空间内向前滑动。因此，N常被称为**窗口长度**，GBN协议也经常被称为**滑动窗口协议**。

​		GBN必须响应三种类型的事件：

​		**上层的调用**：当调用rdt_send()时，先检查窗口是否满，如果未满，产生有个分组并发送，相应的更新变量。如果满，发送方只需要将实际数据返回给上层，隐式指示窗口已经满了。然后上层可能会过会儿再试。实际中可能会缓存（不立即发送）这些数据，或者使用同步机制，允许上层在仅当窗口不满的时候调用rdt_send()

​		**收到一个ACK**：在GBN协议里，对序号为n的分组的确认采取**累积确认**,的方式，表明接收方已正确接收到序号为n的以前且包括n的所有分组。

​		**超时事件**：协议的名字"回退N步“来源于出现丢失和延时过长分组时发送方的行为。就像停等协议中的那样，定时器将再次用于恢复数据或确认分组的丢失。如果超时，发送发将重新发送已经发送但是还未确认的分组。如果收到一个ACK但是仍然有已经发送但是未确认的分组，那么计时器将重新启动。如果没有，则停止计时器。



### 3.4.4	选择重传

​		选择重传（SR）协议通过让发送方重传那些它怀疑在接收方出错（即丢失或受损）的分组而避免不必要的重传。

![可靠乬传输机制及其用途](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200712112143185.png)



## 3.5	面向连接的运输：TCP

### 3.5.1	TCP连接

​		这种TCP“连接”你是像电路交换网络中的端到端TDM或FDM电路，相反该“连接”是一条逻辑连接，它的状态仅保留在两个通信系统的TCP程序中。TCP协议只在端系统中运行，而不在中间的网络元素（路由器和链路层交换机）中，所以中间的网络元素不会维持TCP连接状态。

​		TCP连接提供的是**全双工服务**：如果一台主机上的进程A与另一台的进程B存在一条TCP连接，那么应用层数据就可在进程B流向进程A，也可以从A到B。TCP连接也总是**点对点**的，不能在一次发送操作中从一个发送方将数据传送给多个接收方。

​		客户首先发送一个特殊的TCP报文段，服务器用另一个特殊的TCP报文段来响应，最后客户再用第三个报文段作为响应。前两个报文段不承载“有效载荷”，也就是不包含应用层数据，而第三个报文段可以承载有效载荷。这种连接建立的过程常被称为**三次握手**。

​		一旦建立起一条TCP连接，两个应用进程之间就可以互相发送数据了，客户进程通过套接字传递数据流，数据一旦通过该套接字，它就由客户中运行的TCP控制了。TCP将浙西数据引导到了该连接的发送缓存里，TCP可以从缓存中取出并放入报文段的数据数量受限于**最大报文长度（MSS）**。MSS通常根据本地发送主机发送的最大链路层帧长度（即**最大传输单元**）来设置，该MSS是指报文段里应用层数据的最大长度。

​		TCP为每块客户数据配上一个TCP首部，从而形成多个TCP**报文段**，这些报文段被下传给网络层，网络层将其分别封装在网络层IP数据报中。

![TCP发送和接收缓存](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200712115633689.png)



3.5.2	TCP报文段结构

![image-20200712122442388](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200712122442388.png)

​		32比特的**序号字段**和32比特的**确认号字段**。被TCP发送和接收方实现可靠数据传输服务。

​		16比特的**接收窗口字段**，用于流浪控制，指示接收方愿意接受的字节数。

​		4比特的**首部长度字段**，该字段指示了以32比特的字为单位的TCP首部长度。

​		可选与变长的**选项字段**，该字段用于发送方与接收方协商最大报文长度（MSS）时或在高速网络环境下用作窗口调节因子时使用。

​		6比特的**标志字段**。**ACK比特**用于指示确认字段中的值是有效的，即该报文段包括一个对已被成功接收报文段的确认。		RST、SYN和FIN比特用于连接建立和拆除。在明确拥塞通告中使用了CWR和ECE比特。当PSH比特被置位时，就指示接收方应立即将数据交给上层。URG比特用来指示报文段里存在着被发送端的上层实体置为“紧急”的数据。紧急数据的最后一个字节由16比特的紧急数据指针字段指出。



1.序号和确认号

​		TCP把数据看成一个无结构的、有序的字节流。因为序号是建立在传送的字节流之上，而不是报文段的序列之上。**一个报文段的序号**。假设主机A向主机B发送一个数据流。主机A中的TCP隐式地对数据流中的每一个字节编号。数据流包含50万字节的文件组成，其MSS为1000字节，数据流的首字节编号为0，TCP为该数据流构建500个报文段，给第一个报文段分配序号0，第二个为1000，第三2000。

​		确认号，比如从A到B，B已经收到了一个字节0~535的报文段，B还想要536~899的报文段就在下个发往A的报文段的确认号上填上一个536代表想要536后的数据。

​		因为TCP只确认第一个丢失字节为止的字节，所以TCP被称为**累积确认**。



### 3.5.3	往返时间的估计与超时

1.估计往返时间

​		报文段的样本RTT（表示为SampleRTT）就是从某报文段发出，到对该报文段的确认被收到之间的时间量。大多数TCP的实现仅在某个时刻做一次SampleRTT测量，而不是为每个都测量。显然，由于路由器的拥塞和端系统负载的变化，SampleRTT值会随之波动。

2.设置和管理重传超时间间隔

![计算超时](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200712144944603.png)



### 3.5.4	可靠数据传输

​		1.一些有趣的情况

​		2.超时间隔加倍

​		3.快速重传：冗余ACK

​		如果TCP发送方接收到对相同数据的三个冗余ACK，它吧这当做一种指示，说明在这个已被确认过3次的报文段之后的报文段已经丢失。一旦收到3个冗余ACK，TCP就执行快速重传。

​		4.是退回N步还是选择重传



### 3.5.5	流量控制

​		TCP为它的应用程序提供了**流量控制服务**以消除发送方使接收方缓存溢出的可能性。

![接收窗口和接收缓存](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200712165727600.png)



### 3.5.6	TCP连接管理

​		第一步：客户端的TCP首先向服务器端的TCP发送一个特殊的TCP报文段，不包含应用层数据。在该报文段首部的一个标志位SYN比特被置为1。客户会随机的选择一个初始序号（client_isn），并将此编号放置于该起始的TCP SYN报文段的序号字段中。该报文段被封装在一个IP数据报中，发送给服务器。

​		第二步：一旦包含TCP SYN报文段的IP数据报到达服务器主机，服务器会从该数据报中提取出TCP SYN报文段，为该TCP连接分配TCP缓存和变量，并向客户TCP发送允许连接的报文段。这个允许连接的报文段也不包含应用层数据。但是，在报文段的首部却包含3个重要的信息。首先SYN比特被置为1.其次，该TCP报文段首部的确认号字段被置为Client_isn+1。最后，服务器选择自己的初始序号（server_isn1），并将其放置到TCP报文段首部的序号字段中。表明了我收到你发起建立连接的SYN分组，该分组中带有初始序号Client_isn。我同意建立连接。我自己的初始序号是server_isn。该允许连接的报文段被称为**SYNACK报文段**。

​		第三步：在收到SYNACK报文段后，客户也要给该连接分配缓存和变量。客户主机则向服务器发送另外一个报文段；这最后一个报文段对服务器的允许连接的报文段进行了确认（该客户通过将值server_isn+1放置到TCP报文段首部的确认字段中来完成此项工作）。因为连接已经建立了，所以该SYN比特被置为0。该三次握手的第三个阶段可以在报文段负载中携带客户到服务器的数据。

![TCP三次握手报文段交换](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200713124645510.png)





​		客户端应用进程发出一个关闭连接命令，客户TCP向服务器进程发送一个TCP报文段，首部中的标志位FIN比特被设置为1。当服务器接收到该报文就向发送方回送一个确认报文段。然后服务器发送它自己的终止报文段，其FIN比特被置为1。最后，该客户对这个服务器的终止报文段进行确认。此时两台主机上用于该连接的所有资源都被释放了。

![关闭TCP连接](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200713125035632.png)



## 3.7	TCP拥塞控制

​		1.慢启动

​		2.拥塞避免

​		3.快速恢复





# 4	网络层：数据平面

## 4.1	网络层概述

### 4.1.1	转发和路由器选择：数据平面和控制平面

​		转发：当一个分组到达路由器的一条输入链路时，该路由器必须将该分组移动到适当的输出链路。数据平面实现的唯一功能。

​		路由选择：当分组从发送方流向接收方时，网络层必须决定这些分组所采用的路由或者路劲。计算这些路劲的算法被称为**路由选择算法**。控制平面中实现。

## 4.2	路由器工作原理

![路由体系结构](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200714142437754.png)

​		输入端口：终结入物理链路的物理层功能，这个功能在输入端口最左侧的方框和输出最右侧方框中。它还要与位于链路远端的数据链路层交互来执行数据链路层功能，在输入与输出端口的中间方框。在输入端口还要执行查找功能，在输入端口最右侧的方框中，正是在这里通过查询转发表决定路由器的输出端口。

​		交换结构：是将路由器的输入端口连接到它的输出端口。

​		输出端口：输出端口存储充交换结构接收的分组，并通过执行必要的链路层和物理层功能在输出链路上传输这些分组。

​		路由选择处理器：执行控制平面功能。在传统的路由器中，它执行路由选择协议，维护路由选择表语关联链路状态信息，并为路由器计算转发表。在SDN路由器（soft defined network）中，路由选择处理器（在其他活动中）负责与远程控制器通信，目的是接收由远程控制器计算的转发表项，并在该路由器的输入端口安装这些表项。还执行网络管理功能。



4.2.1	输入端口处理和基于目的地转发

![输入端口处理](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200714145819687.png)

4.2.2	交换

![三种交换技术](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200714153822603.png)

​		经内存交换：最简单、最早的路由器是传统的计算机，在输入端口与输出端口之间的交换是在CPU（路由选择处理器）的直接控制下完成的。输入与输出端口的功能就像在传统操作系统中的I/O设备一样。一个分组到达一个输入端口时，该端口会先通过中端方式想路由选择处理器发出信号，然后该分组被复制到处理器内存中，路由器选择处理器则从其首部中提取目的地址，在转发表中找出适当的输出端口，并将该分组复制到输出端口的缓存中。

​		经总线交换：在这种方法中，输入端口经一根共享总线直接传送到输出端口，不需要路由选择处理器的干预。通过以下方式完成该任务：让输入端口为分组预先计划一个交换机内部标签（首部），指示温蒂输出端口，使分组在总线上传送和输出到输出端口。该分组能由所有输出端口收到，单只有与该标签匹配的端口才能保存该分组，然后标签在输出端口被去除。因为其仅用于交换机内部来跨越总线。如果有多个分组同时到达路由器，每个位于不同的输出端口，除了一个分组外所有其他分组必须的等待，因为一次只有一个分组能够跨越总线。因为每个分组必须跨过单一总线，所以路由器的交换带宽受总线速率的限制。

​		经互联网络交换：克服单一、共享式总线带宽限制的一种方法是，使用一个更复杂的互联网络。纵横式交换机 就是一种由2N条总线组成的互联网络。纵横式交换机**是非阻塞的**，只要没有其他分组当前被转发到该输出端口，转发到输出端口的分组将不会被达到输出端口的分组阻塞。



4.2.3	输出端口处理

![输出端口处理](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200714155627767.png)

4.2.4	何时出现排队

1.输入排队

​		**线路前部阻塞**

2.输出排队

​		当没有足够的内存来缓存一个入分组时，就必须做出决定：要么丢弃到达的分组（采用一种称谓**弃尾**的策略），要么删除一个或多个已排队的分组来为新的分组腾出空间。**主动队列管理**



4.2.5	分组调度

1.**先进先出（FIFO）**

​		也称先来先服务FCFS，

2.**优先权排队**

​		在优先权排队规则下，到达输出链路的分组被分类放入输出队列中的优先权类。

![优先权排队模型](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200714164847711.png)

**非抢占式优先权排队**



3.**循环加权公平排队**

![加权公平排队](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200714165102056.png)





## 4.3	网际协议：IPv4、寻址、IPv6及其他

### 4.3.1	IPv4数据报格式

![IPv4 数据报格式](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200715140628755.png)



​		版本（号）：这4比特规定了数据报的IP协议版本，通过查看版本号，路由器能够确定如何解释IP数据报的剩余部分。不同的IP版本使用不同的数据报格式。

​		首部长度：应为一个IPv4数据报可以包含一些可变数量的选项，需要这4比特来确定IP数据报中被封装的运输层报文段实际开始的地方。大多数IP数据报不包含选项，所以一般的IP数据报具有20字节的首部。

​		服务类型：服务类型比特包含在IPv4首部中，以便使不同类型的IP数据报（例如，一些特别要求低延时，高吞吐量的可靠性的数据报）能相互区别开来。比如IP电话应用和非实时流量。

​		数据报长度：这是IP数据报的总长度。以字节计算，虽然理论最大长度为65535字节，但是很少有超过1500字节的，因为以太网 帧 能够承载不超过1500字节。

​		标识、标志、片偏移：这三个字段与所谓IP分片有关。

​		寿命：用来确保数据报不会永远在网络中循环。每当一台路由器处理数据报时，该字段值减1。如果为0，则该数据报必须丢弃。

​		协议：该字段仅当到达目的地的时候才会有用，该字段指示了IP数据报的数据部分该交给哪个特定的运输层协议。例如值为6表明要交给TCP，为17交给UDP。它是将网络层与运输层绑定到一起的粘合剂。类似于运输层报文段中端口号字段所起的作用。端口号是将运输层和应用层绑定到一起的粘合剂。

​		首部检验和：将首部每2个字节当做一个数，用反码算数求和。

​		源和目的IP地址：插入IP地址

​		选项：该字段允许IP首部被拓展。很少使用。影响性能。

​		数据：可以存放TCP或UDP报文段。也可以承载其他类型的数据，如ICMP报文。



4.3.2	IPv4数据报分片

​		不是所有链路层协议都能承载相同长度的网络层分组，有的协议能承载大数据报，而有的只能承载小分组。例如以太网帧能承载不超过1500字节的数据，某些广域网链路不超过576字节的数据。一个链路层帧能承载最大数据量叫做**最大传送单元（MTU，Maximum Transmission Unit）**。

​		一台互联几条链路的路由器，且每条链路运行具有不同MTU的链路层协议，收到一个IP数据报，通过检查转发表确定出链路，该条出链路的MTU比IP数据报的长度要小。 将IP数据报中的数据分片分成两个或更多个小的IP数据报，用单独的链路层帧封装这些较小的IP数据报，然后通过输出链路发送这些帧，这些较小的数据报称为**片**。

​		片在它到达目的地的运输层以前需要重新组装，TCP与UDP都希望从网络层收到完整的、未分片的报文。这个问题在端系统中解决。

​		当生成一个数据报的时候，发送主机在该数据报设置源和目的地址的同时贴上标识号，发送主机通常将它发送的每个数据报的标识号加1，路由器对数据报分片的时候，形成的每个数据报（即片）具有出书数据报的源、目的地址与标识号，当目的地主机从同一发送主句收到 一系列数据报的时候，它能够检查标识号确定哪些数据报实际上是同一较大数据报的片，由于IP是一种不可靠的服务，可能一个或多个片可能永远不能到达目的地，所以让最后一个片的标志比特设为0，其他所有的片标志比特为1。为了让目的主机确定是否丢失了一个片（还能让其按正确的顺序重新组装片），使用偏移字段指定该片应该放在哪个位置。



### 4.3.3	IPv4编址

​		**点分十进制记法**，193.32.216.9二进制记法 11000001 001000000 11011000 00001001

![接口地址与子网](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200715155829608.png)

​		IP编址为这个子网分配一个地址223.1.1.0/24，其中的/24记法，有时称为子网掩码。指示32比特中，左侧24比特定义了子网地址。因此223.1.1.0/24由3个主机接口，和1个路由器接口组成。任何其他要连到这个网络的主机都要求其地址具有223.1.1.xxx的形式。

​		因特网的地址分配策略被称为**无类别域间路由选择（CIDR）**。CIDR将子网寻址的概念一般化了。当使用子网寻址的时候32位的IP地址被划分为两部分，a.b.c.d/x，其中x指示了地址的第一部分中的比特数。

​		a.b.c.d/x的地址的x最高比特构成了IP地址的网络部分，并且经常被称为该地址的**前缀**。一个组织通常被分配一块连续的地址，即具有相同前缀的地址。在这种情况下，该组织内部的设备的IP地址将贡献共同的前缀。

​		在CIDR被采用之前，IP地址的网络部分被限制长度为8、16或24比特，被称为**分类编址**的编址方案。分别被称为A、B和C类网络、C类子网能容纳2^8-2 = 254（其中2个用特殊用途）台主机，B类有65534台。在这种方法下，如果有2000台主机的组织分配一个B类地址那么B类地址的空间迅速损耗。

​		IP广播地址255.255.255.255，当一台主机发出目的地址为这样的数据报的时候，该报文会交付给同一个网络的所有主机。

​		

​		1.获取一块地址

​		2.获取主机地址：动态主机配置协议

​		某组织一旦获得了一块地址，它就可以为它的主机与路由器接口逐个分配IP地址。主机地址能手动配置，但是这项任务目前更多的是使用**动态主机配置协议（DHCP）**来完成。DHCP允许主机自动获取一个IP地址。网络管理员能够配置DHCP使给定的主机每次获得相同的IP地址，或**临时的IP地址**。

​		由于DHCP具有将主机连接进一个网络的网络相关方面的自动能力，它又被称为即**插即用协议**，或者**零配置协议**。



### 4.3.4 网络地址转换

​		NAT（network address translation）**网络地址转换**

​		路由器的本地子网地址和外网地址的转换，路由器有一张**NAT表**，外网WAN口，内网LAN口。





### 4.3.5	IPv6

![IPV6数据报格式](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200715165122679.png)

1.IPv6的数据报格式

2.从IPv4到IPv6的迁移



## 4.4	通用转发和SDN

​		匹配加动作转发表在OpenFlow 中称为**流标**。它的每个表项包括：

​		首部字段值的集合：入分组将与之匹配。与基于目的地转发的情况予以，基于硬件匹配在TCAM内存中执行最为迅速（TCAM内存中可能有上百万条地址表项）。匹配不上流表项的分组将被丢弃或发送到远程控制器做更多处理。

​		计数器集合（当分组与流表项匹配时更新计数器）：这些计数器可以包括已经与该表项匹配的分组数量，以及从该表项上次更新以来的时间。

​		当分组匹配流表项时所采取的动作集合：这些动作可能将分组转发到给定的输出端口、丢弃该分组、复制该分组和将他们发送到多个输出端口。和/或重写所选的首部字段。

4.4.1	匹配

![OpenFlow 流表](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200716150301847.png)



4.4.2	动作

​		每个流表项都有0个或多个动作列表，这些动作决定了应用于与流表项匹配的分组处理，如果有多个动作，它们在表中规定的次序执行。

​		动作可能是：

​		转发：一个入分组可以转发到一个特定的物理输出端口，广播到所有端口，或通过所选的端口集合进行多播。

​		丢弃：没有动作的流表项表明某个匹配的分组应当被丢弃。

​		修改字段：在分组被转发到所选的输出端口之前，分组首部10个字段中的值可以重写。



# 5	网络层：控制平面

## 5.1	概述

​		每路由器控制：每台路由器中都包含转发和路由选择功能。每台路由器有一个路由选择组件，用于与其他路由器中的路由选择组件通信，以计算其转发表的值。

​		逻辑集中式控制：通用的“匹配加动作”抽象允许执行传统的IP转发以及其他功能（负载共享、防火墙功能和NAT）的丰富集合，而这些功能先前是在单独的中间盒中实现的。



## 5.2	路由选择算法

​		**集中式路由选择算法**：用完整的、全局性的网络知识计算出从源到目的地之间的最低开销路径。具有全局状态信息的算法常被称作**链路状态算法**，因为该算法必须知道网络中每条链路的开销。

​		**分散式路由选择算法**：路由器以迭代分布式的方式计算出最低开销路径。没有节点拥有关于网络链路开销的完整信息。相反，每个节点仅有与其直接相连链路的开销知识即可开始工作。通过迭代计算过程以及相邻节点的信息交换，一个节点组件计算出到达某目的节点或一组目的节点的最低开销路径。**距离向量算法**。

​		路由选择算法的第二种广义分类方式是根据算法是静态的还是动态的进行分类。在**静态路由选择算法**中，路由随时间的变化非常缓慢，通常是人工进行调整。**动态路由选择算法**，随着网络流量负载或拓扑发生变化而变化而改变路由选择路径。

​		第三种分类方式：根据它是负载敏感的还是负载迟钝的进行划分。在**负载敏感算法**中，链路开销会动态地变化以反映出底层链路的当前拥塞水平。如果当前拥塞的一条链路与高开销联系，则算法趋向于绕开该拥塞链路来选择路由。当今的因特网路由选择算法都是**负载迟钝**的，应为某条链路的开销不明确地反应其当前（或最近的）的拥塞水平。

5.2.1	链路状态路由选择算法

5.2.2	距离向量路由选择算法





## 5.5	SDN控制平面

SDN体系结构具有4个关键特征

​		基于流的转发：SDN控制的交换机的分组转发工作，能够基于运输层、网络层或链路层的首部中任意数量的首部字段进行。在之前我们看到了OpenFlow 基于11个不同的字段值进行转发。传统方法中IP数据报的转发仅依据数据报的目的IP地址进行。分组转发规则被精确规定在交换机的流表中；SDN控制平面的工作是计算、管理安装所有网络交换机中的流表项。

​		数据平面与控制平面分离：数据平面由网络交换机组成，交换机是相对简单（但快速）的设备，该设备在他们的流表中执行“匹配加动作”的规则。控制平面由服务器以及决定和管理交换机流表的软件组成。

​		网络控制功能：位于数据平面和交换机外部。SDN控制平面是由软件实现，与传统的路由器不同，这个软件在服务器上执行，该服务器与网络交换机截然分开且与之远离。

​		可编程的网络：通过运行在控制平面中的网络控制应用程序，该网络是可编程的。使用了SDN控制器提供的API来定义和控制网络设备中的数据平面。

![SND体系结构组件](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200717132822898.png)



### 5.5.1	SDN控制平面：SDN控制器和SDN网络控制应用程序





## 5.6	ICMP：因特网控制报文协议











# 6	链路层和局域网

## 6.1	链路层概述

### 6.1.1	链路层提供的服务

链路层协议能够提供的可能服务包括：

​		成帧：在每个网络层数据报经链路传输之前，几乎所有的链路层协议都要将其用链路层帧封装起来。一个帧由一个数据字段和若干首部字段组成，网络层数据报就插在数据字段中。

​		链路接入：**媒体访问控制（Medium Access Control,MAC）**协议规定了帧在链路上传输的规则。对于在链路的一端，仅有一个发送方，链路的另一端仅有一个接收方的点对点链路，MAC协议比较简单（或者不存在），即无论何时链路空闲，发送方都能够发送帧。当多个节点共享单个广播链路时，即所谓多路访问问题，MAC协议用于协调多个节点的帧传输。

​		可靠交付：当链路层协议提供可靠交付服务时，它保证无差错地经链路层移动每个网络层数据报。链路层可靠交付服务通常用于易于产生高差错率的链路，例如无线链路，其目的是本地（也就是在差错发生的链路上）纠正一个差错，而不是通过运输层或应用层协议迫使进行端到端的数据重传。对于低比特差错的链路，包括光纤、同轴电缆和许多双绞铜线链路，链路层可靠交付可能会被认为是一种不必要的开销，所有许多有线链路层协议不提供可靠交付服务。

​		差错检测和纠正：当帧中的一个比特作为1传输时，接收方节点中的链路层硬件不可能将其判断为0，反之亦然。这种比特差错是由信号衰减和电磁噪声导致的，因为没有必要转发一个有差错的数据报，所以链路层协议提供一种机制来检测这样的比特差错。通过发送节点在帧中包括差错检测比特，让接收节点来进行差错检测，以此来完成这项工作。差错纠正类似于差错检测，区别在于接收方不仅能检测帧中出现的比特差错，而且能够准确地确定帧中的差错出现的位置（并因此纠正这些差错）。



### 6.1.2	链路层在何处实现

​		链路层的主题部分是在**网络适配器**中实现的，有时也称为**网络接口卡**。



## 6.2	差错检测和纠正技术

### 6.2.1	奇偶校验

![偶校验](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200718103139849.png)

​		二维奇偶校验

![二维](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200718103221864.png)

​		接收方检验和纠错的能力被称为**前向纠错**，通常用于如音频CD这样音频存储和回放设备中。



### 6.2.2	检验和方法

​		**因特网检验和**就基于这种方法。

### 6.2.3	循环冗余检测

​		收发双方约定好一个生成多项式G（x）。

​		发送方基于待发送的数据和生成多项式计算出差错检测码（冗余码），将其添加到待传输数据后面一起传输。

​		接收方通过生成多项式来计算收到的数据是否产生了误码，余数为0

​		

​		漏检率非常低，计算比较复查，但是易于用硬件实现，因此被广泛应用于数据链路层



## 6.3	多路访问链路和协议

​		多路访问协议划分为3种类型：信道划分协议，随机接入协议，轮流协议。

### 6.3.1	信道划分协议

​		时分多路复用（TDM）和频分多路复用（FDM）是两种能够用于在所有共享信道节点之间划分广播信道带宽的技术。

​		TDM是将时间划分为**时间帧**，在吧时间帧划分为**时隙**，分给不同的节点使用。

​		FDM将信道划分为不同的频段，吧每个频率分给节点。

​		**码分多址**，为每个节点分配不同的编码，节点用编对数据进行编码，就能正确接收发送方编码的数据比特。



### 6.3.2	随机接入协议

​		在传输节点总是以信道的全部速率进行发送，当有碰撞时，设计碰撞的每个节点反复地重发它的帧（也就是分组），到该帧无碰撞地通过为止，但是有碰撞的时候该节点不是立即就重发，而是在它重发之前等待一个随机的时延，随机时延是独立选择，所以这些节点之一所选择的时延充分小鱼其他碰撞节点的时延，所以它能够无碰撞的发出。



### 6.3.3	轮流协议





## 6.4	交换局域网

​		1.MAC地址

​		链路层地址有各种不同的称呼：**LAN 地址、物理地址或MAC地址**。MAC地址是固定的，每个字节用一对16进制数表示，有6个字节。MAC地址具有扁平结构，不像IP地址具有的层次结构那样，IP地址的一部分可能是一个网络，而IP的整个地址是在这个网络里的。



​		2.**地址解析协议（ARP）**

​		网络层地址（IP地址）和链路层地址（MAC地址），所以需要他们之间进行转换。对于因特网而言，这是**地址解析协议（ARP，Address Resolution Protocol）**的任务。

​		在很多方面它和DNS类似，DNS将主机名解析为IP地址。然而，DNS为在因特网任何地方的主机解析主机名，而ARP只为在同一个子网上的主机和路由器接口解析IP地址。

​		每台主机或路由在其内存中具有一个**ARP表**，这张表包含IP地址到MAC地址的映射关系。该ARP表也包含一个寿命（TTL）值，它指示了从表中删除每个映射的时间。

![ARP表](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200719132615156.png)

​		首先查询ARP报文是在广播帧中发送的，而响应ARP报文是在一个标准帧中发送。



​		3.发送数据报到子网以外

​		发送一个IP数据报，发送主机向它的适配器传递数据报，但是必须指示一个目的MAC地址，首先会指示路由器的MAC地址，发送到路由器后，到达路由器的网络层，网络层根据IP查询路由表，发送端对应的目的接口，到达适配器，通过ARP查询到MAC分装到一个新的帧。



6.4.2	以太网

​		1.以太网帧

![以太网帧](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200719135246939.png)

​		数据字段（46~1500字节）：这个字段承载了IP数据报。以太网的最大传输单元（MTU）是1500字节。如果超过，主机将IP数据报分片。最小长度46字节，当采用填充

​		目的地址（6字节）：这个字段包含目的的适配器的MAC地址。当目的适配器收到一个以太网帧，帧的目的地址无论是BB-BB-BB-BB-BB-BB还是MAC广播地址，它都将该帧的数据字段的内容传递给网络层。如果它收到了具有其他MAC地址的帧则丢弃。

​		源地址（6字节）：这个字段包含了传输到该帧到局域网上的适配器的MAC地址。

​		类型字段（2字节）：该字段允许以太网复用多种网络层协议。如果到达的帧包含ARP分组，则该ARP分组将被多路分解给ARP协议。与网络层中的协议子弹、运输层报文段的端口号子弹类似。都是为了把一层中的某协议与上一层的某协议结合起来。

​		CRC（4字节）：CRC（循环冗余检测）字段的目的是使得接收适配器检测帧中是否引入了差错。

​		前同步码（8字节）：以太网帧以一个8字节的同步码字段开始。该同步码的前7个字节的值都是10101010；最后一个字节是10101011。前7个字节用于“**唤醒**”接收适配器，并且将它们的时钟和发送方的时钟同步。前7字节的比特，就能够锁定适配器A的时钟，第8个字节的最后俩个（连续的1）比特警告适配器B，“重要的内容”就要来了。



### 6.4.3	链路层交换机

​		1.交换机转发和过滤

​		**过滤**是决定一个帧一个转发到某个接口还是应该丢弃的功能。

​		**转发**是决定一个帧一个呗导向哪个接口，并吧该帧移动到那些接口的交换机功能。

​		交换机的过滤和转发借助于交换机表完成。该交换机表包含某局域网上某些主机和路由器的但不必是全部的表项。交换机表中的一个表项包含：1.一个MAC地址 2.通向该MAC地址的交换机接口  3.表项放置在表中的时间。

![交换机表的一部分](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200719142419494.png)

​		2.自学习

​		交换机是**自学习**的。

​		

​		3.链路层交换机的性质

​		消除碰撞

​		异质的链路：交换机链路彼此隔离，因此局域网中的不同链路能够以不同的速率运行，并且能够在不同的媒体上运行。

​		管理：除了提供强化的安全性，交换机也易于进行网络管理。



​		6.4.4虚拟局域网







## 6.7	回顾：Web页面请求的历程

![web页面请求历程](C:\Users\YUNTUN\AppData\Roaming\Typora\typora-user-images\image-20200720110333847.png)

假设DHCP服务器运行在路由器中，comcast.net为学校提供DNS服务

### 6.7.1	准备：DHCP、UDP、IP和以太网

​		1）Bob的电脑上的操作系统生成一个**DHCP请求报文**，将这个报文放入具有目的端口67（DHCP服务器）和源端口68（DHCP客户）的**UDP报文段**，该UDP报文段被放在一个具有广播IP的目的地址（255.255.255.255）和源IP地址0.0.0.0的**IP数据报**中。

​		2）包含DHCP请求报文的IP数据报则被放置在**以太网帧**中。该以太网具有的目的MAC地址FF:FF:FF:FF:FF:FF，使该帧广播到与交换机连接的所有设备（如果顺利的话也包括DHCP服务器）；该帧的源MAC地址是Bob的笔记本的MAC地址 00:16:D3:23:8A.

​		3）包含DHCP请求的广播以太网帧是第一个由Bob笔记本发送到以太网交换机的帧，该交换机在所有的出口端广播入帧，包括连接到路由器的端口。

​		4）路由器在它的具有MAC地址00:22:6B:45:1F的接口接收到该广播以太网帧，该帧中包含了DHCP请求，并且该以太网帧中抽取出IP数据报。该数据报的广播IP目的地址指示了这个IP数据报应当由在该节点的高层协议处理，因此该数据报的载荷（一个UDP报文段）**被分解**向上到达UDP，DHCP请求报文从此UDP报文段抽取出来。此时DHCP服务器有了DHCP请求报文。

​		5）假设运行在路由器中的DHCP服务器能够以**CIDR**块68.85.2.0/24分配IP地址。在学校内使用的所有IP地址都在Comcast的地址块中。假设DHCP服务器分配地址68.85.2.101给Bob的笔记本。DHCP服务器生成包含这个IP地址以及DNS服务器的IP地址（68.87.71.226）、默认网关冷却液的IP地址（68.85.2.1）和子网块（68.85.2.0/24）（等价为“网络掩码”）的一个**DHCP ACK报文**。该DHCP报文被放入一个UDP报文段中，UDP报文段被放入一个IP数据报中，IP数据报被放入一个以太网帧中。这个以太网帧的源MAC地址是路由器连到归属网络时接口的MAC地址（00:22:6B:45:1F:1B），目的的MAC地址是Bob笔记本的MAC地址（00:16:D3:23:8A）。

​		6）包含DHCP ACK的以太网帧由路由器发送给交换机。因为交换机是**自学习**的，并且先前从Bob笔记本收到（包含DHCP请求的）以太网帧，所以该交换机知道寻址到00:16:D3:23:68:8A的帧仅从通向Bob笔记本的输出端口转发。

​		7）Bob笔记本接收到包含DHCP ACK的以太网帧，从该以太网中抽取IP数据报，从IP数据报中抽取UDP报文段，从UDP报文段抽取DHCP ACK报文。Bob的DHCP客户则记录下它的IP地址和它的DNS服务器的IP地址。它还在其**IP转发表**中安装默认网关的地址。Bob笔记本已经初始化好它的网络组件，并准备开始处理Web页面获取。

### 6.7.2	仍在准备：DNS和ARP

​		当Bob将www.google.com的URL键入其Web浏览器时，他开启了一长串时间，这将导致谷歌主页最终显示在其Web浏览器上。Bob的Web浏览器通过生成一个**TCP套接字**，开始了该过程，套接字用于谷歌发送**HTTP请求**。为了生成该套接字，Bob便携机将需要知道谷歌的IP地址。使用**DNS协议**提供这种名字到IP地址的转换服务。

​		8）Bob笔记本上的操作系统因此生成了一个**DNS查询报文**，将字符串www.google.com放入DNS报文的问题段中。该DNS报文则放在一个具有53号目的端口的UDP报文段中，该UDP报文段则被放入具有IP目的地址68.87.71.226（在第5步中DHCP ACK返回的DNS服务器地址）和源IP地址68.85.2.101的IP数据报中。

​		9）Bob笔记本则将包含DNS请求报文的数据报放入一个以太网帧中。该帧将发送（在链路层寻址）到Bob学校网络的网关路由器。然而，即使Bob笔记本经过上述第5步中的DHCP ACK报文知道了学校网关路由器的IP地址（68.85.2.1），但仍不知道该网关路由器的MAC地址。为了获得该网关路由器的MAC地址，Bob笔记本将需要使用**ARP协议**。

​		10）Bob笔记本生成一个具有目的IP地址（68.85.2.1）的**ARP查询报文**，将该ARP报文放置在一个具有广播目的地址（FF:FF:FF:FF:FF:FF）的以太网帧中，并且向交换机发送该以太网帧，交换机将该帧交付给所有连接的设备，包括网关路由器。

​		11）网关路由器在通过学校网络的接口上接收到包含该ARP查询报文的帧，发现在ARP报文中目标IP地址68.85.2.1匹配其接口的IP地址。网关路由器因此准备一个**ARP回答**，指示它的MAC地址00:22:6B:45:1F:1B对应IP地址68.85.2.1。它将ARP回答放在一个以太网帧中，其目的地址为Bob笔记本的MAC地址，并向交换机发送该帧，再由交换机交付给Bob笔记本。

​		12）Bob笔记本姐搜狐包含ARP回答报文的帧，并从ARP回答报文中抽取网关路由器的MAC地址（00:22:6B:45:1F:1B）。

​		13）Bob笔记本现在终于能够使包含DNS查询的以太网帧寻址到网关路由器的MAC地址。注意到在该帧中的IP数据报具有IP目的地址68.85.71.266（DNS服务器），而该帧具有目的地址00:22:6B:45:1F:1B（网关路由器）。Bob向交换机发送该帧，交换机将该帧交付给网关路由器。

6.7.3	仍在准备：域内路由选择到DNS服务器

​		14）网关路由器接收到该帧并抽取包含DNS查询的IP数据报。路由器查找该数据报的目的地址（68.87.71.226），并根据其转发表确定该数据报应当发送到图6-32的Comcast网络中最左边的路由器。IP数据报防止在链路层中，该链路适合将学校路由器连接到最左边Comcast路由器，并且该帧经过这条链路发送。

​		15）在Comcast网络中最左边的路由器接收到该帧，抽取IP数据报，检查该数据报的目的地址（68.87.71.266），并根据其转发表确定出接口，经过该接口朝着DNS服务器转发数据报，而转发表已根据Comcast的域内协议以及**因特网的域间协议BGP**所填写。

​		16）最终包含DNS查询的IP数据报到达了DNS服务器。DNS服务器抽取出DNS查询报文，在它的DNS数据库中查找名字www.google.com，找到对应的IP地址（64.233.169.105）的**DNS源记录**（假设它当前缓存在DNS服务器中）。前面讲过这种缓存数据源于google.com的**权威DNS服务器**。该DNS服务器形成了一个包含这种主机名到IP地址映射的**DNS回答报文**，将该DNS回答报文放入UDP报文段中，该报文段放入寻址到Bob笔记本（68.85.2.101）的IP数据报中。该数据报通过将Comcast网络反向转发到学校的路由器，并从这里经过以太网交换机到Bob笔记本。

​		17）Bob笔记本从DNS报文抽取服务器www.google.com的IP地址。最终在大量工作后，Bob笔记本此时准备接触谷歌服务器。

### 6.7.4	Web客户-服务器交互：TCP和HTTP

​		18）既然Bob笔记本有了谷歌的IP地址，他能够生成**TCP套接字**，该套接字将用于向谷歌发送**HTTP GET报文**。当Bob生产TCP套接字时，在Bob笔记本中的TCP必须首先与www.google.com中的**TCP执行三次握手**。Bob笔记本因此首先生成一个具有端口80（针对HTTP的）的**TCP SYN**报文段，将该TCP报文段放置在具有目的IP地址64.233.169.105（谷歌IP）的IP数据报中，将该数据报放置在MAC地址为00:22:6B:45:1F:1B（网关路由器）的帧中，并向交换机发送该帧。

​		19）在学校、Comcast网络和谷歌网络中的路由器朝着谷歌转发包含TCP SYN 的数据报，使用每台路由器中的转发表，如前面步骤14~16那样。前面讲过支配分组经Comcast和谷歌网络之间链路转发的路由器转发表项，是由**BGP协议**决定的。

​		20）最终，包含TCP SYN的数据报到达www.google.com。从数据报抽取出TCP SYN报文并分解到与端口80相联系的欢迎套接字。对于谷歌HTTP服务器和Bob笔记本之间的TCP连接生成一个套接字。产生一个TCP SYNACK报文，将其放入向Bob笔记本寻址的一个数据报中，最后放入链路层帧中，该链路适合将www.google.com连接到第一台路由器。

​		21）包含TCP SYNACK报文段的数据报通过谷歌、Comcast和学校网络，最终到达Bob笔记本的以太网卡。数据报在操作系统中分解到步骤18生成的TCP套接字，从而进入连接状态。

​		22）借助于Bob便携机中的套接字，现在（终于）准备向谷歌发送字节了，Bob的浏览器生成包含要获取的URL的HTTP GET报文。HTTP GET报文则写入套接字，其中GET报文称为一个TCP报文段的载荷。该TCP报文段放置一个数据报中，并交付到www.google.com，入前面步骤18~20所述。

​		23）在谷歌的HTTP服务器中从TCP套接字读取HTTP GET报文，生成一个**HTTP响应报文**，将全球的Web页面内容放入HTTP响应体中，并将报文发送进TCP套接字中。

​		24）包含HTTP回答报文的数据报通过谷歌、Comcast和学校网络转发，到达Bob笔记本。Bob的Web浏览器程序从套接字读取HTTP响应，从HTTP响应体重抽取Web的html，并最终显示了Web网页。





#### 简述：

​		操作系统生成DHCP请求报文，封装到UDP报文段，IP目的地址为广播地址，源地址为4个0，然后封装到以太网帧中去，目的MAC为6个FF。

​		该帧通过交换机广播到所有出口，包括路由器的端口，然后路由器拆出IP数据报，该数据报的目的地址标识这个IP数据报应该由在该节点的高层协议处理，因此递交给UDP，然后UDP抽取出DHCP请求，此时DHCP服务器就有了DHCP请求报文（假设DHCP服务器在路由器的情况）。

​		随后DHCP服务器以DICR的网络块，分配IP地址，服务器生成了这个IP地址，然后把这个IP地址、DNS服务器的IP地址、默认网关的默认地址和子网块（等价网络掩码）这四个东西放在了DHCP ACK报文里，这个报文放入一个UDP报文段，然后再放入IP数据报和以太网帧，在以太网帧的源MAC里填写的是路由器到归属网络时接口的MAC，差不多等价于网关入网络的第一个MAC。

​		这个DHCP ACK由这个路由器发送给交换机，由于交换机的**自学习**，因为它之前留意了DHCP的请求报文，由于这个DHCP ACK回来所以它知道了 这个MAC地址到这个源头的笔记本的接口要发往哪。

​		笔记本接收到DHCP ACK的以太网帧，拿出IP数据报，再拿出UDP报文段，在拿出DHCP ACK报文，笔记本电脑的DHCP客户就记录下它的IP地址和DNS服务器的IP地址。还在它的**IP转发表**，安装了末日网关的地址。然后这台笔记本会向默认网关发送除了子网以外的所有数据报，这就是那4条信息的作用。





​		在笔记本电脑中输入谷歌的网址，在生成TCP套接字之前，为了知道谷歌的IP地址，要给DNS服务器发送DNS查询报文，放在53号端口的UDP报文段，报文段又被放入有DNS的IP地址的IP数据报中。放入一个以太网帧中，要发送到网关路由器，但是不知道路由器的MAC地址，笔记本就使用**ARP协议**查询，笔记本生成一个有这个路由器的目的IP地址的ARP查询报文，吧ARP报文放在6个FF的广播地址的以太网帧里，向交换机发送这个帧，交换机发送给所有连接它的设备，到了路由器，路由器查到这个ARP报文中目标IP地址和它这个接收的接口一致，网关路由器就准备了一个**ARP回答**，放入它的MAC地址和IP，放在以太网帧里，目的MAC地址为笔记本的MAC，向交换机发送，交换机再给笔记本。笔记本接收过后，从ARP回答报文里取出网关路由器的MAC地址。

​		现在笔记本有了DNS服务器的IP和网关路由器的MAC地址就能向路由器交付这个帧了。

​		网关路由器接收这个帧，路由器查看目的地址，根据**转发表**转发到Comcast最左边的路由器。IP数据报放置在链路层帧里。在这个Comcast网络最左边的路由器接收到这个帧，抽取IP数据报，检测它的目的IP地址，然后再根据它的转发表确定出接口，这个接口朝着DNS服务器转发数据报，转发表根据这个网络的**域内协议**以及因特网的**域间协议BGP**所填写的。

​		最终DNS查询的IP数据报到了DNS服务器，DNS打开这个查询报文，在它的DNS数据报里查到了谷歌URL所对应的IP地址的**源记录**（缓存在服务器里）这个缓存的数据源于**权威DNS服务器**。这个DNS服务器形成了一个包含这种主机名到IP地址映射的**DNS回答报文**。吧这个报文当道UDP报文段里，这个报文段放入到笔记本的IP数据报里。

​		笔记本从DNS报文里抽取服务器谷歌的IP地址。



​		现在笔记本拥又了谷歌的IP地址，它能够生产**TCP套接字**了，套接字用于想谷歌发送HTTP GET的报文，当笔记本生成TCP套接字的时候，在笔记本中的TCP必须和谷歌的TCP执行**三次握手**，笔记本首先生成一个具有目的端口80的TCP SYN报文段，将该TCP报文段放到有目的IP的数据报里，吧网关的MAC地址放到以太网帧里。向路由器发送。

​		向之前的步骤那样，通过路由器中的转发表转发。最后TCP SYN的数据报到达谷歌服务器，从TCP SYN报文分解到和端口80相联系的欢迎套接字。对于谷歌HTTP服务器和笔记本之间的TCP连接生成一个连接套接字。产生一个TCP SYNACK报文段，发送回笔记本。

​		包含TCP SYNACK报文段通过网络到达笔记本的以太网卡，分解然后生成TCP套接字，从而进入连接状态。借助这个套接字，可以向谷歌发送字节了，笔记本的浏览器生成想要获取的URL的HTTP GET报文。HTTP GET报文则写入套接字，其中GET报文称为一个TCP报文段的载荷，TCP放入数据报交付到谷歌。

​		在谷歌的HTTP服务器从TCP套接字读取HTTP GET报文，生成**HTTP响应**报文，将请求的Web页面放入HTTP响应体中，并发送到套接字，包含HTTP回答报文的数据报通过网络到达笔记本，笔记本Web浏览器程序从套接字读取HTTP响应，从响应体抽取HTML，显示了网页。

​		

​		















































